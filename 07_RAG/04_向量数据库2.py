import os

import dotenv
from langchain_chroma import Chroma
from langchain_core.documents import Document
from langchain_openai import OpenAIEmbeddings

dotenv.load_dotenv()
os.environ["OPENAI_API_KEY"] = os.getenv("OPENAI_API_KEY")
os.environ["OPENAI_API_BASE"] = os.getenv("OPENAI_BASE_URL")
os.environ["TAVILY_API_KEY"] = os.getenv("TAVILY_API_KEY")

#############################################################
# 1. å®šä¹‰æ–‡æ¡£
raw_documents = [
    Document(
        page_content="è‘¡è„æ˜¯ä¸€ç§å¸¸è§çš„æ°´æœï¼Œå±äºè‘¡è„ç§‘è‘¡è„å±æ¤ç‰©ã€‚å®ƒçš„æœå®å‘ˆåœ†å½¢æˆ–æ¤­åœ†å½¢ï¼Œé¢œè‰²æœ‰ç»¿è‰²ã€ç´«è‰²ã€çº¢è‰²ç­‰å¤šç§ã€‚è‘¡è„å¯Œå«ç»´ç”Ÿç´ Cå’ŒæŠ—æ°§åŒ–ç‰©è´¨ï¼Œå¯ä»¥ç›´æ¥é£Ÿç”¨æˆ–é…¿é€ æˆè‘¡è„é…’ã€‚",
        metadata={"source": "æ°´æœ", "type": "æ¤ç‰©"}
    ),
    Document(
        page_content="ç™½èœæ˜¯åå­—èŠ±ç§‘è”¬èœï¼ŒåŸäº§äºä¸­å›½åŒ—æ–¹ã€‚å®ƒçš„å¶ç‰‡å±‚å±‚åŒ…è£¹å½¢æˆç´§å¯†çš„çƒçŠ¶ï¼Œå£æ„Ÿæ¸…è„†å¾®ç”œã€‚ç™½èœå¯Œå«è†³é£Ÿçº¤ç»´å’Œç»´ç”Ÿç´ Kï¼Œå¸¸ç”¨äºåˆ¶ä½œæ³¡èœã€ç‚’èœæˆ–ç…®æ±¤ã€‚",
        metadata={"source": "è”¬èœ", "type": "æ¤ç‰©"}
    ),
    Document(
        page_content="ç‹—æ˜¯äººç±»æœ€æ—©é©¯åŒ–çš„åŠ¨ç‰©ä¹‹ä¸€ï¼Œå±äºçŠ¬ç§‘ã€‚å®ƒä»¬å…·æœ‰é«˜åº¦ç¤¾ä¼šæ€§ï¼Œèƒ½ç†è§£äººç±»æƒ…ç»ªï¼Œå¸¸è¢«ç”¨ä½œå® ç‰©ã€å¯¼ç›²çŠ¬æˆ–è­¦çŠ¬ã€‚ä¸åŒå“ç§çš„ç‹—åœ¨ä½“å‹ã€æ¯›è‰²å’Œæ€§æ ¼ä¸Šæœ‰å¾ˆå¤§å·®å¼‚ã€‚",
        metadata={"source": "åŠ¨ç‰©", "type": "å“ºä¹³åŠ¨ç‰©"}
    ),
    Document(
        page_content="çŒ«æ˜¯å°å‹è‚‰é£Ÿæ€§å“ºä¹³åŠ¨ç‰©ï¼Œæ€§æ ¼ç‹¬ç«‹ä½†ä¹Ÿèƒ½ä¸äººç±»å»ºç«‹äº²å¯†å…³ç³»ã€‚å®ƒä»¬å¤œè§†èƒ½åŠ›æå¼ºï¼Œæ“…é•¿æ•çŒè€é¼ ã€‚å®¶çŒ«çš„å“ç§åŒ…æ‹¬æ³¢æ–¯çŒ«ã€æš¹ç½—çŒ«ç­‰ï¼Œæ¯›è‰²å’ŒèŠ±çº¹å¤šæ ·ã€‚",
        metadata={"source": "åŠ¨ç‰©", "type": "å“ºä¹³åŠ¨ç‰©"}
    ),
    Document(
        page_content="äººç±»æ˜¯åœ°çƒä¸Šæœ€å…·æ™ºæ…§çš„ç”Ÿç‰©ï¼Œå±äºçµé•¿ç›®äººç§‘ã€‚ç°ä»£äººç±»ï¼ˆæ™ºäººï¼‰æ‹¥æœ‰é«˜åº¦å‘è¾¾çš„å¤§è„‘ï¼Œåˆ›é€ äº†è¯­è¨€ã€å·¥å…·å’Œæ–‡æ˜ã€‚äººç±»çš„å¹³å‡å¯¿å‘½çº¦70 - 80å¹´ï¼Œåˆ†å¸ƒåœ¨å…¨çƒå„åœ°ã€‚",
        metadata={"source": "ç”Ÿç‰©", "type": "çµé•¿ç±»"}
    ),
    Document(
        page_content="å¤ªé˜³æ˜¯å¤ªé˜³ç³»çš„ä¸­å¿ƒæ’æ˜Ÿï¼Œç›´å¾„çº¦139ä¸‡å…¬é‡Œï¼Œä¸»è¦ç”±æ°¢å’Œæ°¦ç»„æˆã€‚å®ƒé€šè¿‡æ ¸èšå˜ååº”äº§ç”Ÿèƒ½é‡ï¼Œä¸ºåœ°çƒæä¾›å…‰å’Œçƒ­ã€‚å¤ªé˜³æ´»åŠ¨å‘¨æœŸçº¦ä¸º11å¹´ï¼Œä¼šå½±å“åœ°çƒæ°”å€™ã€‚",
        metadata={"source": "å¤©æ–‡", "type": "æ’æ˜Ÿ"}
    ),
    Document(
        page_content="é•¿åŸæ˜¯ä¸­å›½å¤ä»£çš„å†›äº‹é˜²å¾¡å·¥ç¨‹ï¼Œæ€»é•¿åº¦è¶…è¿‡2ä¸‡å…¬é‡Œã€‚å®ƒå§‹å»ºäºæ˜¥ç§‹æˆ˜å›½æ—¶æœŸï¼Œç§¦æœè¿æ¥å„æ®µï¼Œæ˜æœå¤§è§„æ¨¡é‡ä¿®ã€‚é•¿åŸæ˜¯ä¸–ç•Œæ–‡åŒ–é—äº§å’Œäººç±»å»ºç­‘å¥‡è¿¹ã€‚",
        metadata={"source": "å†å²", "type": "å»ºç­‘"}
    ),
    Document(
        page_content="é‡å­åŠ›å­¦æ˜¯ç ”ç©¶å¾®è§‚ç²’å­è¿åŠ¨è§„å¾‹çš„ç‰©ç†å­¦åˆ†æ”¯ã€‚å®ƒæå‡ºäº†æ³¢ç²’äºŒè±¡æ€§ã€æµ‹ä¸å‡†åŸç†ç­‰æ¦‚å¿µï¼Œå½»åº•æ”¹å˜äº†äººç±»å¯¹ç‰©è´¨ä¸–ç•Œçš„è®¤çŸ¥ã€‚é‡å­è®¡ç®—æœºæ­£æ˜¯åŸºäºè¿™ä¸€ç†è®ºå‘å±•è€Œæ¥ã€‚",
        metadata={"source": "ç‰©ç†", "type": "ç§‘å­¦"}
    ),
    Document(
        page_content="ã€Šçº¢æ¥¼æ¢¦ã€‹æ˜¯ä¸­å›½å¤å…¸æ–‡å­¦å››å¤§åè‘—ä¹‹ä¸€ï¼Œä½œè€…æ›¹é›ªèŠ¹ã€‚å°è¯´ä»¥è´¾ã€å²ã€ç‹ã€è–›å››å¤§å®¶æ—çš„å…´è¡°ä¸ºèƒŒæ™¯ï¼Œæç»˜äº†è´¾å®ç‰ä¸æ—é»›ç‰çš„çˆ±æƒ…æ‚²å‰§ï¼Œåæ˜ äº†å°å»ºç¤¾ä¼šçš„ç§ç§çŸ›ç›¾ã€‚",
        metadata={"source": "æ–‡å­¦", "type": "å°è¯´"}
    ),
    Document(
        page_content="æ–°å† ç—…æ¯’ï¼ˆSARS-CoV-2ï¼‰æ˜¯ä¸€ç§å¯å¼•èµ·å‘¼å¸é“ç–¾ç—…çš„å† çŠ¶ç—…æ¯’ã€‚å®ƒé€šè¿‡é£æ²«ä¼ æ’­ï¼Œä¸»è¦ç—‡çŠ¶åŒ…æ‹¬å‘çƒ­ã€å’³å—½ã€ä¹åŠ›ã€‚ç–«è‹—å’Œæˆ´å£ç½©æ˜¯æœ‰æ•ˆçš„é¢„é˜²æªæ–½ã€‚",
        metadata={"source": "åŒ»å­¦", "type": "ç—…æ¯’"}
    )
]

# 2. åˆå§‹åŒ–åµŒå…¥æ¨¡å‹
embedding_model = OpenAIEmbeddings(model="text-embedding-ada-002")

# 3. åˆ›å»ºå‘é‡æ•°æ®åº“
db = Chroma.from_documents(
    documents=raw_documents,
    embedding=embedding_model,
    persist_directory="/chroma_db_2",    # Tipsï¼šåªèƒ½è®¾ç½®ä¸€æ¬¡ï¼Œå¦åˆ™åŒä¸€ä»½æ–‡æœ¬ä¼šæ”¾å…¥å¤šæ¬¡, å¯¼è‡´æ•°æ®åº“ä¸­å¤šé‡å¤æ•°æ®
)

# 4. ç»“æœæŸ¥è¯¢
'''
4.1 ç›¸ä¼¼æ€§æ£€ç´¢ï¼ˆsimilarity_searchï¼‰
'''
# query = "å“ºä¹³åŠ¨ç‰©"
# docs = db.similarity_search(query, k=3)  # k=3 è¡¨ç¤ºè¿”å›3ä¸ªæœ€ç›¸å…³æ–‡æ¡£

'''
4.2 æ”¯æŒç›´æ¥å¯¹é—®é¢˜å‘é‡æŸ¥è¯¢ï¼ˆsimilarity_search_by_vectorï¼‰
    å®ƒå…ˆå°†é—®é¢˜è½¬æ¢ä¸ºå‘é‡å‚æ•°åˆ—è¡¨, ç„¶åä»¥æ­¤æ¥æŸ¥è¯¢å‘é‡æ•°æ®åº“
'''
# query = "å“ºä¹³åŠ¨ç‰©"
# embedding_vector = embedding_model.embed_query(query)
# docs = db.similarity_search_by_vector(embedding_vector, k=3)

'''
4.3 ç›¸ä¼¼æ€§æ£€ç´¢ï¼Œæ”¯æŒè¿‡æ»¤å…ƒæ•°æ®ï¼ˆfilterï¼‰
'''
# query ="å“ºä¹³åŠ¨ç‰©"
# docs = db.similarity_search(query=query, k=5, filter={"source":"åŠ¨ç‰©"})

'''
4.4 é€šè¿‡L2è·ç¦»åˆ†æ•°è¿›è¡Œæœç´¢ï¼ˆsimilarity_search_with_scoreï¼‰
    åˆ†æ•°å€¼è¶Šå°ï¼Œæ£€ç´¢åˆ°çš„æ–‡æ¡£è¶Šå’Œé—®é¢˜ç›¸ä¼¼ã€‚åˆ†å€¼å–å€¼èŒƒå›´ï¼š[0ï¼Œæ­£æ— ç©·]
'''
# query = "é‡å­åŠ›å­¦æ˜¯ä»€ä¹ˆ?"
# docs = db.similarity_search_with_score(query)
# for doc, score in docs:
#     print(f" [L2è·ç¦»å¾—åˆ†={score:.3f}] {doc.page_content} [{doc.metadata}]")

'''
4.5 é€šè¿‡ä½™å¼¦ç›¸ä¼¼åº¦åˆ†æ•°è¿›è¡Œæœç´¢ï¼ˆ_similarity_search_with_relevance_scoresï¼‰
    åˆ†æ•°å€¼è¶Šæ¥è¿‘1ï¼ˆä¸Šé™ï¼‰ï¼Œæ£€ç´¢åˆ°çš„æ–‡æ¡£è¶Šå’Œé—®é¢˜ç›¸ä¼¼ã€‚
'''
# docs = db._similarity_search_with_relevance_scores("é‡å­åŠ›å­¦æ˜¯ä»€ä¹ˆ?")
# for doc, score in docs:
#     print(f"* [ä½™å¼¦ç›¸ä¼¼åº¦å¾—åˆ†={score:.3f}] {doc.page_content} [{doc.metadata}]")

'''
4.6 MMRï¼ˆæœ€å¤§è¾¹é™…ç›¸å…³æ€§ï¼Œmax_marginal_relevance_searchï¼‰
    MMR æ˜¯ä¸€ç§å¹³è¡¡ ç›¸å…³æ€§ å’Œ å¤šæ ·æ€§ çš„æ£€ç´¢ç­–ç•¥ï¼Œé¿å…è¿”å›é«˜åº¦ç›¸ä¼¼çš„å†—ä½™ç»“æœã€‚
    lambda_mult å‚æ•°å€¼ä»‹äº 0 åˆ° 1 ä¹‹é—´ï¼Œç”¨äºç¡®å®šç»“æœä¹‹é—´çš„å¤šæ ·æ€§ç¨‹åº¦ï¼Œå…¶ä¸­ 0 å¯¹åº”æœ€å¤§å¤šæ ·æ€§ï¼Œ1 å¯¹åº”æœ€å°å¤šæ ·æ€§ã€‚é»˜è®¤å€¼ä¸º 0.5ã€‚
'''
# docs = db.max_marginal_relevance_search(
#     query="é‡å­åŠ›å­¦æ˜¯ä»€ä¹ˆ",
#     lambda_mult=0.5,  # ä¾§é‡ç›¸ä¼¼æ€§
# )
# print("ğŸ” å…³äºã€é‡å­åŠ›å­¦æ˜¯ä»€ä¹ˆã€‘çš„æœç´¢ç»“æœï¼š")
# print("="* 50)
# for i, doc in enumerate(docs):
#     print(f"ğŸ“– ç»“æœ {i + 1}:")
#     print(f"ğŸ“Œ å†…å®¹: {doc.page_content}")
#     print(f"ğŸ· æ ‡ç­¾: {', '.join(f'{k}={v}' for k, v in doc.metadata.items())} \n")

# 5. æ‰“å°
# print(f"æŸ¥è¯¢'{query}'çš„ç»“æœ:")
# for i,doc in enumerate(docs, 1):
#     print(f"ç»“æœ {i}:")
#     print(f"å†…å®¹: {doc.page_content}")
#     print(f"å…ƒæ•°æ®: {doc.metadata} \n")
